---
title: "06 - analysis 2"
format: html
editor: visual
execute:
  cache: false
---

# PCA analysis 

## Aim

We explore the gene expression dataset using Principal Component Analysis (PCA).

We work with the augmented tidy dataset created in 03_augment.qmd and check whether patients separate in the PCA space depending on clinical variables such as the alive status and age category.

## Setup

```{r}
library("tidyverse")
```

## Load augmented data

```{r}
data_augmented <- readRDS("../data/data_augmented.rds")

data_augmented |>
  slice_sample(n = 10)
```

## Select most variable genes

Since PCA works best with genes that vary a lot across samples, we select the top 500 most variable genes based on the variance of log2_expression.

```{r}
gene_var <- data_augmented |>
  group_by(Ensembl_ID) |>
  summarise(var_log2 = var(log2_expression, na.rm = TRUE), .groups  = "drop") |>
  arrange(desc(var_log2))

gene_var |>
  slice_head(n = 10)

top_genes <- gene_var |>
  slice_head(n = 500) |>
  pull(Ensembl_ID)

length(top_genes)
```

## Build expression matrix for PCA

Here, we create a wide matrix with one row per sample (patient) and one column per gene (for the selected 500 genes). We also extract the clinical variables so we can link them to the PCA results later.

```{r}
expr_wide <- data_augmented |>
  filter(Ensembl_ID %in% top_genes) |>
  select(sample, Ensembl_ID, log2_expression) |>
  distinct() |>
  pivot_wider(names_from  = Ensembl_ID,values_from = log2_expression)

pheno_pca <- data_augmented |>
  select(sample, alive, age_cat, age_at_index.demographic) |>
  distinct()

expr_wide <- expr_wide |>
  left_join(pheno_pca, by = "sample")

expr_wide |>
  slice_head(n = 5)
```

## Run PCA

We extract the numeric expression data, centre and scale it, and run PCA using prcomp().

```{r}
expr_mat <- expr_wide |>
  select(-sample, -alive, -age_cat, -age_at_index.demographic) |>
  as.matrix()

dim(expr_mat)

```

```{r}
set.seed(123)

pca_res <- prcomp(
  x      = expr_mat,
  center = TRUE,
  scale. = TRUE)


var_explained <- tibble(
  component = seq_along(pca_res$sdev),
  var_explained = pca_res$sdev^2 / sum(pca_res$sdev^2))

var_explained |>  
  slice(1:5)

```

## Scree plot

This plot shows how much variance is explained by each principal component.

```{r}

scree_df <- var_explained |>
  transmute(
    component,
    PC = stringr::str_c("PC", component),
    variance = var_explained) |>
  mutate(
    PC = forcats::fct_reorder(PC, component))


scree_plot <- scree_df |>
  slice_head(n = 15) |>
  ggplot(aes(x = PC, y = variance, group = 1)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Variance explained by principal components",
    x = "Principal component",
    y = "Proportion of variance explained") +
  theme_minimal()

scree_plot

```

```{r}
ggsave(filename = "../results/06_pca_scree.png",
  plot = scree_plot,
  width = 7,
  height = 5)
```

The scree plot shows that most of the global variation comes from PC1. If there is a biological separation between patient groups, it should appear mainly along PC1 or PC2.

## PC1 vs PC2 coloured by clinical variables

Here, we plot PC1 vs PC2 and colour the samples by alive status and shape by age category.

```{r}
scores <- as_tibble(pca_res$x, rownames = "row_id") |>
  bind_cols(expr_wide |> select(sample, alive, age_cat, age_at_index.demographic)) |>
  relocate(sample)

scores |>
  slice_head(n = 5)
```

```{r}
pc1_label <- var_explained |>
  slice(1) |>
  mutate(label = stringr::str_c("PC1 (", scales::percent(var_explained), ")")) |>
  pull(label)

pc2_label <- var_explained |>
  slice(2) |>
  mutate(label = stringr::str_c("PC2 (", scales::percent(var_explained), ")")) |>
  pull(label)


pc1_pc2_plot <- scores |>
  ggplot(aes(
    x = PC1,
    y = PC2,
    colour = alive,
    shape  = age_cat)) +
  geom_point(alpha = 0.8) +
  labs(
    title = "PCA on top 500 most variable genes",
    subtitle = "Colour: alive status, shape: age category",
    x = pc1_label,
    y = pc2_label) +
  theme_minimal()

pc1_pc2_plot
```

```{r}
ggsave(filename = "../results/06_pca_pc1_pc2.png",
  plot = pc1_pc2_plot,
  width = 7,
  height = 5)
```

There is no clear separation between the groups in PC1â€“PC2 space. Both the alive/deceased groups and the age categories are mixed together, so these variables do not seem to drive the main variation.

## Conclusion

Running PCA on the 500 most variable genes shows that the major variation in gene expression is not linked to the clinical variables considered here. PC1 and PC2 capture global transcriptomic patterns, but these patterns do not reflect differences in survival status or age.

# 
