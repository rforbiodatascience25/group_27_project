---
title: "06 - analysis 2"
format: html
editor: visual
execute:
  cache: false
---

# PCA analysis

## Aim

We explore the gene expression dataset using Principal Component Analysis (PCA).

We work with the augmented tidy dataset created in 03_augment.qmd and check whether patients separate in the PCA space depending on clinical variables such as the alive status and age category.

## Setup

```{r}
# Load packages
library("tidyverse")
```

## Load augmented data

```{r}
# Load the augmented dataset
data_augmented <- readRDS("../data/data_augmented.rds")

# Show 10 random rows to check the data
data_augmented |>
  slice_sample(n = 10)
```

## Select most variable genes

Since PCA works best with genes that vary a lot across samples, we select the top 500 most variable genes based on the variance of log2_expression.

```{r}
# Calculate variance for each gene
# We keep genes that change the most across samples
gene_var <- data_augmented |>
  group_by(Ensembl_ID) |>
  summarise(var_log2 = var(log2_expression, na.rm = TRUE), .groups  = "drop") |>
  arrange(desc(var_log2))

# Show top 10 most variable genes
gene_var |>
  slice_head(n = 10)

# Select the 500 most variable genes
top_genes <- gene_var |>
  slice_head(n = 500) |>
  pull(Ensembl_ID)

length(top_genes)
```

## Build expression matrix for PCA

Here, we create a wide matrix with one row per sample (patient) and one column per gene (for the selected 500 genes). We also extract the clinical variables so we can link them to the PCA results later.

```{r}
# Build a wide expression matrix for PCA
# One row = one sample, one column = one gene
expr_wide <- data_augmented |>
  filter(Ensembl_ID %in% top_genes) |>
  select(sample, Ensembl_ID, log2_expression) |>
  distinct() |>
  pivot_wider(names_from  = Ensembl_ID,values_from = log2_expression)

# Keep clinical information for each sample
pheno_pca <- data_augmented |>
  select(sample, alive, age_cat, age_at_index.demographic) |>
  distinct()

# Add clinical variables to the expression matrix
expr_wide <- expr_wide |> left_join(pheno_pca, by = "sample")

# Check the first rows
expr_wide |> slice_head(n = 5)
```

## Run PCA

We extract the numeric expression data, centre and scale it, and run PCA using prcomp().

```{r}
# Prepare the numeric matrix for PCA
expr_mat <- expr_wide |>
  select(-sample, -alive, -age_cat, -age_at_index.demographic) |>
  as.matrix()

dim(expr_mat)

```

```{r}
# Run PCA (data is centered and scaled)
set.seed(123)
pca_res <- prcomp(
  x      = expr_mat,
  center = TRUE,
  scale. = TRUE)

# Calculate variance explained by each PC
var_explained <- tibble(
  component = seq_along(pca_res$sdev),
  var_explained = pca_res$sdev^2 / sum(pca_res$sdev^2))

```

## Scree plot

This plot shows how much variance is explained by each principal component.

```{r}
# Prepare data for the scree plot
scree_df <- var_explained |>
  transmute(
    component,
    PC = stringr::str_c("PC", component),
    variance = var_explained) |>
  mutate(
    PC = forcats::fct_reorder(PC, component))

# Plot the variance explained by the first PCs
scree_plot <- scree_df |>
  slice_head(n = 15) |>
  ggplot(aes(x = PC, y = variance, group = 1)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Variance explained by principal components",
    x = "Principal component",
    y = "Proportion of variance explained")

scree_plot

```

```{r}
# Save the scree plot
ggsave(filename = "../results/06_pca_scree.png",
  plot = scree_plot,
  width = 7,
  height = 5)
```

The scree plot shows that most of the global variation comes from PC1. If there is a biological separation between patient groups, it should appear mainly along PC1 or PC2.

## PC1 vs PC2 coloured by clinical variables

Here, we plot PC1 vs PC2 and colour the samples by alive status and shape by age category.

```{r}
# Build a table with PCA scores + clinical data
scores <- as_tibble(pca_res$x, rownames = "row_id") |>
  bind_cols(expr_wide |> select(sample, alive, age_cat, age_at_index.demographic)) |>
  relocate(sample)

scores |>
  slice_head(n = 5)
```

```{r}
# Labels for the axes including the explained variance
pc1_label <- var_explained |>
  slice(1) |>
  mutate(label = stringr::str_c("PC1 (", scales::percent(var_explained), ")")) |>
  pull(label)

pc2_label <- var_explained |>
  slice(2) |>
  mutate(label = stringr::str_c("PC2 (", scales::percent(var_explained), ")")) |>
  pull(label)

# Plot PC1 vs PC2 coloured by clinical variables
pc1_pc2_plot <- scores |>
  ggplot(aes(
    x = PC1,
    y = PC2,
    colour = alive,
    shape  = age_cat)) +
  geom_point(alpha = 0.8) +
  labs(
    title = "PCA on top 500 most variable genes",
    subtitle = "Colour: alive status, shape: age category",
    x = pc1_label,
    y = pc2_label)

pc1_pc2_plot
```

```{r}
# Save the PC1–PC2 plot
ggsave(filename = "../results/06_pca_pc1_pc2.png",
  plot = pc1_pc2_plot,
  width = 7,
  height = 5)
```

There is no clear separation between the groups in PC1–PC2 space. Both the alive/deceased groups and the age categories are mixed together, so these variables do not seem to drive the main variation.

## Conclusion

Running PCA on the 500 most variable genes shows that the major variation in gene expression is not linked to the clinical variables considered here. PC1 and PC2 capture global transcriptomic patterns, but these patterns do not reflect differences in survival status or age.

# 
