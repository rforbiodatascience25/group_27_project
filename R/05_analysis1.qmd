---
title: "05 - analysis 1"
format: html
editor: visual
execute:
  cache: false
---

## Loading libraries and data

```{r}
library("tidyverse")
```

```{r}
# Load 3 tables
phenotype <- readRDS("../data/phenotype_clean.rds")
gen_exp <- readRDS("../data/gen_exp_clean.rds")
data_augmented <- readRDS("../data/data_augmented.rds")
```

## Distribution of the variables and analysis

FIGO Stage Distribution : The bar plot shows the distribution of patients across FIGO stages. From the plot, it is clear that the majority of patients are classified as stage IIIC, while the numbers in other stages (stage IC, IIA, IIB, IIC, IIIA, IIIB, IIIC and IV) are considerably lower. This uneven distribution suggests that most patients in this dataset were diagnosed at an advanced stage of disease, which is common for ovarian cancers due to late detection. Because the dataset is heavily skewed toward Stage III, it is difficult to draw meaningful comparisons between stages or to identify trends related to clinical outcomes across the full spectrum of FIGO stages.

```{r}
data_augmented |>
  group_by(sample) |>
  slice(1) |>
  filter(!is.na(figo_stage.diagnoses)) |>
  ggplot(aes(x = figo_stage.diagnoses)) +
    geom_bar() +
    labs(title = "distribution of FIGO stages",
       x = "FIGO stage",
       y = "number of patients")
```

Alive or death status : The bar plot shows the distribution of patients classified as "alive" or "dead" in the dataset. While the plot provides a visual overview of survival status, the interpretation is limited because we lack detailed information about the causes of death, the timing of events, or the follow-up duration. Without this contextual information, it is not possible to draw meaningful conclusions regarding survival patterns, treatment effectiveness, or disease progression. The data simply indicate whether a patient was recorded as alive or dead at a certain point, but do not capture the underlying clinical or temporal context necessary for a robust survival analysis.

```{r}
data_augmented |>
  group_by(sample) |>
  slice(1) |>
  ggplot(aes(x = alive)) +
    geom_bar() +
    labs(title = "distribution of alive patients",
       x = "alive",
       y = "number of patients")
```

primary vs recurent tumor : we can see that for most of the patients, the tumor is primary

```{r}
data_augmented |>
  group_by(sample) |>
  slice(1) |>
  ggplot(aes(x = tumor_descriptor.samples)) +
    geom_bar() +
    labs(title = "distribution of primary vs recurent tumor",
       x = "primary vs recurent",
       y = "number of patients")
```

types of treatment : the types of treatment are almost equally distributed

```{r}
data_augmented |>
  group_by(sample) |>
  slice(1) |>
  ggplot(aes(x = treatment_type.treatments.diagnoses)) +
    geom_bar() +
    scale_x_discrete(labels = c(
      "['Pharmaceutical Therapy, NOS', 'Radiation Therapy, NOS']" = "pharmaceutical before radiation",
      "['Radiation Therapy, NOS', 'Pharmaceutical Therapy, NOS']" = "radiation before pharmaceutical")) +
    labs(title = "distribution of ptypes of treatment",
       x = "types of treatment",
       y = "number of patients")
```

```{r}
# Select most variable gene
gene_var <- data_augmented |>
  group_by(Ensembl_ID) |>
  summarise(var_log2 = var(log2_expression, na.rm = TRUE), .groups = "drop") |>
  arrange(desc(var_log2))

# Choose the top variable gene
gene_x <- gene_var$Ensembl_ID[1]

# Filter data for this gene and compute survival duration
df_gene <- data_augmented |>
  filter(Ensembl_ID == gene_x) |>
  mutate(
    survival_days = case_when(
      alive == TRUE  ~ days_to_last_follow_up.diagnoses,
      alive == FALSE ~ days_to_death.demographic,
      TRUE ~ NA_real_
    )
  )

# -------------------------------------------------------------
# Boxplot: Expression vs Alive
# -------------------------------------------------------------
ggplot(df_gene, aes(x = alive, y = log2_expression)) +
  geom_boxplot(fill = "#a6cee3") +
  labs(
    title = paste("Expression of gene", gene_x, "in alive vs dead patients"),
    x = "Alive status",
    y = "log2(expression)"
  ) +
  theme_minimal()

# -------------------------------------------------------------
# Scatter plot + Regression: Survival vs Expression
# -------------------------------------------------------------
ggplot(df_gene, aes(x = log2_expression, y = survival_days, color = alive)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = paste("Survival time vs expression for gene", gene_x),
    x = "log2(expression)",
    y = "Survival (days)"
  ) +
  theme_minimal()

# -------------------------------------------------------------
# Linear model summary
# -------------------------------------------------------------
lm(survival_days ~ log2_expression, data = df_gene) |> summary()
```
