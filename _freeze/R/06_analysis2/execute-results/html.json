{
  "hash": "4df61ee4710eda77d3f501228225efc1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"06 - analysis 2\"\nformat: html\neditor: visual\nexecute:\n  cache: false\n---\n\n## Aim\n\nIn this document, we perform an exploratory analysis of the gene expression data using Principal Component Analysis (PCA).\n\nWe use the augmented tidy dataset created in `03_augment.qmd` and investigate whether patients separate in PCA space according to clinical variables such as `alive` status and age category.\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'tidyverse' a été compilé avec la version R 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'ggplot2' a été compilé avec la version R 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'readr' a été compilé avec la version R 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'purrr' a été compilé avec la version R 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'stringr' a été compilé avec la version R 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'forcats' a été compilé avec la version R 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.6\n✔ forcats   1.0.1     ✔ stringr   1.6.0\n✔ ggplot2   4.0.1     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.2.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n:::\n\n\n## Load augmented data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_augmented <- readRDS(\"../data/data_augmented.rds\")\n\ndata_augmented |>\n  slice_sample(n = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 54\n   sample           Ensembl_ID         sum_gene_exp expression race.demographic\n   <chr>            <chr>                     <dbl>      <dbl> <chr>           \n 1 TCGA-23-1026-01B ENSG00000091640.8         1615.       3.15 white           \n 2 TCGA-13-1498-01A ENSG00000113594.10         757.       1.66 white           \n 3 TCGA-09-1665-01B ENSG00000145293.16        1786.       5.63 white           \n 4 TCGA-04-1655-01A ENSG00000140259.7         1590.       3.32 white           \n 5 TCGA-23-1120-01A ENSG00000207547.1         1140.       3.46 white           \n 6 TCGA-24-1417-01A ENSG00000110218.9         1154.       3.20 white           \n 7 TCGA-25-1630-01A ENSG00000227124.11         437.       1.20 white           \n 8 TCGA-23-1109-01A ENSG00000160602.14         527.       1.18 white           \n 9 TCGA-30-1714-01A ENSG00000279799.1          447.       2.42 white           \n10 TCGA-61-1743-01A ENSG00000213699.9         1697.       3.32 white           \n# ℹ 49 more variables: ethnicity.demographic <chr>, alive <lgl>,\n#   age_at_index.demographic <dbl>, days_to_birth.demographic <dbl>,\n#   year_of_birth.demographic <dbl>, days_to_death.demographic <dbl>,\n#   year_of_death.demographic <dbl>, code.tissue_source_site <chr>,\n#   name.tissue_source_site <chr>, bcr_id.tissue_source_site <chr>,\n#   notes.annotations <chr>, submitter_id.annotations <chr>,\n#   classification.annotations <chr>, created_datetime.annotations <chr>, …\n```\n\n\n:::\n:::\n\n\n## Select most variable genes\n\nPCA is more informative when applied to genes that show substantial variation across samples. We therefore select the top 500 most variable genes based on the variance of `log2_expression`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngene_var <- data_augmented |>\n  group_by(Ensembl_ID) |>\n  summarise(var_log2 = var(log2_expression, na.rm = TRUE), .groups  = \"drop\") |>\n  arrange(desc(var_log2))\n\ngene_var |>\n  slice_head(n = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n   Ensembl_ID         var_log2\n   <chr>                 <dbl>\n 1 ENSG00000226278.1      1.42\n 2 ENSG00000200197.1      1.29\n 3 ENSG00000141096.6      1.23\n 4 ENSG00000253755.1      1.19\n 5 ENSG00000134184.13     1.19\n 6 ENSG00000270372.1      1.16\n 7 ENSG00000277739.1      1.16\n 8 ENSG00000167244.21     1.13\n 9 ENSG00000211662.2      1.10\n10 ENSG00000211935.3      1.10\n```\n\n\n:::\n\n```{.r .cell-code}\ntop_genes <- gene_var |>\n  slice_head(n = 500) |>\n  pull(Ensembl_ID)\n\nlength(top_genes)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 500\n```\n\n\n:::\n:::\n\n\n## Build expression matrix for PCA\n\nWe construct a wide expression matrix with one row per sample and one column per gene (for the selected top 500 genes). We also keep a separate table with clinical covariates per sample.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpr_wide <- data_augmented |>\n  filter(Ensembl_ID %in% top_genes) |>\n  select(sample, Ensembl_ID, log2_expression) |>\n  distinct() |>\n  pivot_wider(names_from  = Ensembl_ID,values_from = log2_expression)\n\npheno_pca <- data_augmented |>\n  select(sample, alive, age_cat, age_at_index.demographic) |>\n  distinct()\n\nexpr_wide <- expr_wide |>\n  left_join(pheno_pca, by = \"sample\")\n\nexpr_wide |>\n  slice_head(n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 504\n  sample           ENSG00000197632.9 ENSG00000167634.12 ENSG00000243236.6\n  <chr>                        <dbl>              <dbl>             <dbl>\n1 TCGA-24-1104-01A             0.597              0.478            0.0410\n2 TCGA-25-1320-01A             1.03               1.13             0.0647\n3 TCGA-24-1850-01A             1.31               2.45             2.89  \n4 TCGA-61-2101-01A             1.12               1.82             0.551 \n5 TCGA-23-1111-01A             0.497              0.223            0.210 \n# ℹ 500 more variables: ENSG00000211655.3 <dbl>, ENSG00000043355.12 <dbl>,\n#   ENSG00000211593.2 <dbl>, ENSG00000170627.11 <dbl>,\n#   ENSG00000169550.14 <dbl>, ENSG00000231476.1 <dbl>, ENSG00000282600.2 <dbl>,\n#   ENSG00000282122.1 <dbl>, ENSG00000244699.1 <dbl>, ENSG00000264063.1 <dbl>,\n#   ENSG00000181449.4 <dbl>, ENSG00000211972.2 <dbl>, ENSG00000259439.2 <dbl>,\n#   ENSG00000105997.22 <dbl>, ENSG00000258484.4 <dbl>,\n#   ENSG00000096006.12 <dbl>, ENSG00000249395.4 <dbl>, …\n```\n\n\n:::\n:::\n\n\n## Run PCA\n\nWe extract the numeric gene expression columns, centre and scale them, and run PCA with `prcomp`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpr_mat <- expr_wide |>\n  select(-sample, -alive, -age_cat, -age_at_index.demographic) |>\n  as.matrix()\n\ndim(expr_mat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 429 500\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\n\npca_res <- prcomp(\n  x      = expr_mat,\n  center = TRUE,\n  scale. = TRUE)\n\nvar_explained <- pca_res$sdev^2 / sum(pca_res$sdev^2)\n\nvar_explained[1:5]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.18880878 0.06278369 0.04250761 0.03633852 0.03106406\n```\n\n\n:::\n:::\n\n\n## Scree plot\n\nWe visualise how much variance is explained by the first principal components.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscree_df <- tibble(\n  PC       = paste0(\"PC\", seq_along(var_explained)),\n  variance = var_explained)\n\nscree_plot <- scree_df |>\n  slice_head(n = 15) |>\n  ggplot(aes(x = PC, y = variance, group = 1)) +\n  geom_col() +\n  geom_line() +\n  geom_point() +\n  scale_y_continuous(labels = scales::percent) +\n  labs(\n    title = \"Variance explained by principal components\",\n    x     = \"Principal component\",\n    y     = \"Proportion of variance explained\") +\n  theme_minimal()\n\nscree_plot\n```\n\n::: {.cell-output-display}\n![](06_analysis2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\n  filename = \"../results/05_pca_scree.png\",\n  plot     = scree_plot,\n  width    = 7,\n  height   = 5)\n```\n:::\n\n\nThis suggests that most of the global variability in the gene expression profiles is driven by a single dominant axis (PC1). Biological separation between clinical groups, if present, is therefore expected to appear mainly along PC1 or PC2.\n\n## PC1 vs PC2 coloured by clinical variables\n\nWe project each sample onto the first two principal components and colour points by `alive` and shape by `age_cat`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscores <- as_tibble(pca_res$x, rownames = \"row_id\") |>\n  bind_cols(expr_wide |>\n              select(sample, alive, age_cat, age_at_index.demographic)) |>\n  relocate(sample)\n\nscores |>\n  slice_head(n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 434\n  sample      row_id   PC1    PC2   PC3   PC4   PC5    PC6    PC7     PC8    PC9\n  <chr>       <chr>  <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>   <dbl>  <dbl>\n1 TCGA-24-11… 1       7.42 -8.70   1.33 -2.09  3.92 -2.51   2.86  -6.48    2.11 \n2 TCGA-25-13… 2       9.39  3.18  -1.64  5.39 -3.90  0.937 -0.183  1.14    0.877\n3 TCGA-24-18… 3       5.65  6.87  -3.47 -1.19  1.35  1.49  -6.81  -0.0208 -4.47 \n4 TCGA-61-21… 4      -2.67  1.63  -5.82  1.74 -3.75 -2.57  -3.73   1.19    3.36 \n5 TCGA-23-11… 5      -9.49 -0.285 -3.06  2.31  2.30  0.682 -0.588 -1.34    3.16 \n# ℹ 423 more variables: PC10 <dbl>, PC11 <dbl>, PC12 <dbl>, PC13 <dbl>,\n#   PC14 <dbl>, PC15 <dbl>, PC16 <dbl>, PC17 <dbl>, PC18 <dbl>, PC19 <dbl>,\n#   PC20 <dbl>, PC21 <dbl>, PC22 <dbl>, PC23 <dbl>, PC24 <dbl>, PC25 <dbl>,\n#   PC26 <dbl>, PC27 <dbl>, PC28 <dbl>, PC29 <dbl>, PC30 <dbl>, PC31 <dbl>,\n#   PC32 <dbl>, PC33 <dbl>, PC34 <dbl>, PC35 <dbl>, PC36 <dbl>, PC37 <dbl>,\n#   PC38 <dbl>, PC39 <dbl>, PC40 <dbl>, PC41 <dbl>, PC42 <dbl>, PC43 <dbl>,\n#   PC44 <dbl>, PC45 <dbl>, PC46 <dbl>, PC47 <dbl>, PC48 <dbl>, PC49 <dbl>, …\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npc1_label <- paste0(\"PC1 (\", scales::percent(var_explained[1]), \")\")\n\npc2_label <- paste0(\"PC2 (\", scales::percent(var_explained[2]), \")\")\n\npc1_pc2_plot <- scores |>\n  ggplot(aes(\n    x      = PC1,\n    y      = PC2,\n    colour = alive,\n    shape  = age_cat)) +\n  geom_point(alpha = 0.8) +\n  labs(\n    title    = \"PCA on top 500 most variable genes\",\n    subtitle = \"Colour: alive status, shape: age category\",\n    x        = pc1_label,\n    y        = pc2_label) +\n  theme_minimal()\n\npc1_pc2_plot\n```\n\n::: {.cell-output-display}\n![](06_analysis2_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\n  filename = \"../results/05_pca_pc1_pc2.png\",\n  plot     = pc1_pc2_plot,\n  width    = 7,\n  height   = 5)\n```\n:::\n\n\nThere is no clear separation between alive and deceased patients along PC1 or PC2. Both groups are widely mixed across the PCA space. Similarly, the age categories do not form distinct clusters, and their points are evenly spread. Overall, the first two principal components capture variability in gene expression, but this variability does not appear to be driven by the clinical variables considered here.\n\n## Genes contributing most to PC1 and PC2\n\nFinally, we inspect which genes contribute most to PC1 and PC2 by looking at the PCA loadings.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloadings <- as_tibble(\n  pca_res$rotation,\n  rownames = \"Ensembl_ID\")\n\ntop_pc1 <- loadings |>\n  select(Ensembl_ID, PC1) |>\n  arrange(desc(abs(PC1))) |>\n  slice_head(n = 20)\n\ntop_pc2 <- loadings |>\n  select(Ensembl_ID, PC2) |>\n  arrange(desc(abs(PC2))) |>\n  slice_head(n = 20)\n\ntop_pc1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 20 × 2\n   Ensembl_ID            PC1\n   <chr>               <dbl>\n 1 ENSG00000244437.1  0.0960\n 2 ENSG00000211949.3  0.0952\n 3 ENSG00000239951.1  0.0952\n 4 ENSG00000132465.12 0.0950\n 5 ENSG00000211660.3  0.0949\n 6 ENSG00000211653.2  0.0949\n 7 ENSG00000224373.3  0.0949\n 8 ENSG00000211938.2  0.0948\n 9 ENSG00000211945.2  0.0948\n10 ENSG00000211668.2  0.0948\n11 ENSG00000211648.2  0.0948\n12 ENSG00000211947.2  0.0946\n13 ENSG00000211966.2  0.0946\n14 ENSG00000211964.3  0.0946\n15 ENSG00000211651.3  0.0946\n16 ENSG00000241351.3  0.0945\n17 ENSG00000243466.1  0.0945\n18 ENSG00000211893.4  0.0944\n19 ENSG00000270550.1  0.0940\n20 ENSG00000211962.2  0.0938\n```\n\n\n:::\n\n```{.r .cell-code}\ntop_pc2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 20 × 2\n   Ensembl_ID            PC2\n   <chr>               <dbl>\n 1 ENSG00000137285.10  0.118\n 2 ENSG00000092758.18  0.117\n 3 ENSG00000149948.14  0.113\n 4 ENSG00000142549.9   0.112\n 5 ENSG00000232835.1   0.111\n 6 ENSG00000148735.15 -0.111\n 7 ENSG00000231295.1  -0.109\n 8 ENSG00000124440.16  0.108\n 9 ENSG00000171236.10 -0.108\n10 ENSG00000236253.7  -0.107\n11 ENSG00000142449.13  0.106\n12 ENSG00000198075.10  0.105\n13 ENSG00000122756.15  0.105\n14 ENSG00000184697.7   0.104\n15 ENSG00000189377.9  -0.103\n16 ENSG00000276644.5   0.101\n17 ENSG00000130294.17  0.101\n18 ENSG00000112319.19  0.101\n19 ENSG00000187634.12  0.100\n20 ENSG00000258815.1   0.100\n```\n\n\n:::\n:::\n\n\nThe genes with the largest absolute loadings on PC1 and PC2 are those that drive the main variation in the dataset. They could be further investigated in a biological context.\n\n## Conclusion\n\nPCA on the top 500 most variable genes reveals that the major sources of transcriptomic variance do not correspond to clinical variables such as survival status or age. The first two PCs capture global variability in gene expression, but this variability appears unrelated to the metadata included here. Genes with the highest loadings drive these main axes of variation and could be investigated further to understand the underlying biological processes.\n",
    "supporting": [
      "06_analysis2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}